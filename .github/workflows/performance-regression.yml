# =============================================================================
# Performance Guards: Protect our performance advantages
# =============================================================================
# All guards use RELATIVE comparisons (gzippy vs other tools on same machine).
# This ensures CI doesn't break when runner specs change.
#
# Uses adaptive benchmarking: runs until CV < 5% (min 10, max 30 trials)
# for statistical significance.
#
# Performance expectations:
# - vs pigz/gzip: MUST be faster (ratio > 1.0)
# - vs rapidgzip: Must be within ±1% (ratio >= 0.99)
# - vs igzip: MUST be >= 90% speed (ratio >= 0.90)
#
# NOTE: Thread counts and compression levels are tested in ci.yml (edge-cases)
# =============================================================================

name: Performance Guards

on:
  pull_request:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

env:
  CARGO_TERM_COLOR: always
  CARGO_HOME: ~/.cargo
  CARGO_INCREMENTAL: 0

jobs:
  # Build all tools once, share via cache
  build:
    name: Build Tools
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake nasm zlib1g-dev

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-guards-${{ hashFiles('**/Cargo.lock') }}

      - name: Build gzippy
        run: cargo build --release

      - name: Build pigz
        run: make -C pigz

      - name: Build rapidgzip
        run: |
          cd rapidgzip/librapidarchive
          mkdir -p build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release -DWITH_ISAL=OFF
          make -j$(nproc) rapidgzip
          # Verify build succeeded
          test -f tools/rapidgzip || (echo "ERROR: rapidgzip build failed" && exit 1)

      - name: Build igzip
        run: |
          cd isa-l
          mkdir -p build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release
          make -j$(nproc) igzip
          # Verify build succeeded
          test -f bin/igzip || (echo "ERROR: igzip build failed" && exit 1)

      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-tools
          path: |
            target/release/gzippy
            pigz/pigz
            pigz/unpigz
            rapidgzip/librapidarchive/build/tools/rapidgzip
            isa-l/build/bin/igzip
          retention-days: 1

  # ============================================================================
  # Guard: BGZF decompression vs pigz
  # ============================================================================
  bgzf:
    name: "Guard: BGZF faster than pigz"
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download tools
        uses: actions/download-artifact@v4
        with:
          name: benchmark-tools
          path: tools

      - name: Setup tools
        run: |
          chmod +x tools/target/release/gzippy
          chmod +x tools/pigz/pigz tools/pigz/unpigz

      - name: Run benchmark
        run: |
          python3 scripts/benchmark_guard.py \
            --type bgzf \
            --gzippy tools/target/release/gzippy \
            --pigz tools/pigz/pigz \
            --unpigz tools/pigz/unpigz

  # ============================================================================
  # Guard: Multi-member decompression vs pigz
  # ============================================================================
  multi-member:
    name: "Guard: Multi-member faster than pigz"
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download tools
        uses: actions/download-artifact@v4
        with:
          name: benchmark-tools
          path: tools

      - name: Setup tools
        run: |
          chmod +x tools/target/release/gzippy
          chmod +x tools/pigz/pigz tools/pigz/unpigz

      - name: Run benchmark
        run: |
          python3 scripts/benchmark_guard.py \
            --type multi-member \
            --gzippy tools/target/release/gzippy \
            --pigz tools/pigz/pigz \
            --unpigz tools/pigz/unpigz

  # ============================================================================
  # Guard: Single-member decompression vs gzip
  # ============================================================================
  single-member:
    name: "Guard: Single-member faster than gzip"
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download tools
        uses: actions/download-artifact@v4
        with:
          name: benchmark-tools
          path: tools

      - name: Setup tools
        run: chmod +x tools/target/release/gzippy

      - name: Run benchmark
        run: |
          python3 scripts/benchmark_guard.py \
            --type single-member \
            --gzippy tools/target/release/gzippy

  # ============================================================================
  # Guard: vs rapidgzip on multi-member files
  # ============================================================================
  vs-rapidgzip-multi:
    name: "Guard: Within 1% of rapidgzip (multi-member)"
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download tools
        uses: actions/download-artifact@v4
        with:
          name: benchmark-tools
          path: tools

      - name: Setup tools
        run: |
          chmod +x tools/target/release/gzippy
          chmod +x tools/pigz/pigz tools/pigz/unpigz
          chmod +x tools/rapidgzip/librapidarchive/build/tools/rapidgzip
          # Verify rapidgzip is available - this is REQUIRED, not optional
          tools/rapidgzip/librapidarchive/build/tools/rapidgzip --version || (echo "ERROR: rapidgzip not available" && exit 1)

      - name: Run benchmark
        run: |
          python3 scripts/benchmark_guard.py \
            --type rapidgzip-multi \
            --gzippy tools/target/release/gzippy \
            --pigz tools/pigz/pigz \
            --rapidgzip tools/rapidgzip/librapidarchive/build/tools/rapidgzip

  # ============================================================================
  # Guard: vs rapidgzip on single-member files
  # ============================================================================
  vs-rapidgzip-single:
    name: "Guard: Within 1% of rapidgzip (single-member)"
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download tools
        uses: actions/download-artifact@v4
        with:
          name: benchmark-tools
          path: tools

      - name: Setup tools
        run: |
          chmod +x tools/target/release/gzippy
          chmod +x tools/rapidgzip/librapidarchive/build/tools/rapidgzip
          # Verify rapidgzip is available - this is REQUIRED, not optional
          tools/rapidgzip/librapidarchive/build/tools/rapidgzip --version || (echo "ERROR: rapidgzip not available" && exit 1)

      - name: Run benchmark
        run: |
          python3 scripts/benchmark_guard.py \
            --type rapidgzip-single \
            --gzippy tools/target/release/gzippy \
            --rapidgzip tools/rapidgzip/librapidarchive/build/tools/rapidgzip

  # ============================================================================
  # Guard: vs igzip on single-threaded decompression
  # ============================================================================
  vs-igzip:
    name: "Guard: >= 90% of igzip (single-threaded)"
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download tools
        uses: actions/download-artifact@v4
        with:
          name: benchmark-tools
          path: tools

      - name: Setup tools
        run: |
          chmod +x tools/target/release/gzippy
          [ -f tools/isa-l/build/bin/igzip ] && chmod +x tools/isa-l/build/bin/igzip || true

      - name: Run benchmark
        run: |
          IGZIP=""
          if [ -f tools/isa-l/build/bin/igzip ]; then
            IGZIP="--igzip tools/isa-l/build/bin/igzip"
          fi
          python3 scripts/benchmark_guard.py \
            --type igzip \
            --gzippy tools/target/release/gzippy \
            $IGZIP

  # ============================================================================
  # Summary of all performance guard results
  # ============================================================================
  summary:
    name: Guards Summary
    needs: [bgzf, multi-member, single-member, vs-rapidgzip-multi, vs-rapidgzip-single, vs-igzip]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check results
        run: |
          echo "## Performance Guards Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Guard | Target | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| BGZF vs pigz | Must be faster (>1.0x) | ${{ needs.bgzf.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Multi-member vs pigz | Must be faster (>1.0x) | ${{ needs.multi-member.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Single-member vs gzip | Must be faster (>1.0x) | ${{ needs.single-member.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| vs rapidgzip (multi) | Within ±1% (>=0.99x) | ${{ needs.vs-rapidgzip-multi.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| vs rapidgzip (single) | Within ±1% (>=0.99x) | ${{ needs.vs-rapidgzip-single.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| vs igzip | >= 90% speed (>=0.90x) | ${{ needs.vs-igzip.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Fail if any guard failed
          if [ "${{ needs.bgzf.result }}" != "success" ] || \
             [ "${{ needs.multi-member.result }}" != "success" ] || \
             [ "${{ needs.single-member.result }}" != "success" ] || \
             [ "${{ needs.vs-rapidgzip-multi.result }}" != "success" ] || \
             [ "${{ needs.vs-rapidgzip-single.result }}" != "success" ] || \
             [ "${{ needs.vs-igzip.result }}" != "success" ]; then
            echo "❌ **Some guards failed. See individual job logs.**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          echo "✅ **All performance guards passed!**" >> $GITHUB_STEP_SUMMARY
