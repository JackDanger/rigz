# =============================================================================
# Performance Guards: Protect our performance advantages
# =============================================================================
# All guards use RELATIVE comparisons (gzippy vs other tools on same machine).
# This ensures CI doesn't break when runner specs change.
#
# Guards:
# - vs pigz: MUST be faster on BGZF, multi-member, and single-member files
# - vs rapidgzip: MUST be faster on both multi-member AND single-member files
# - vs igzip: MUST be >= 90% of igzip speed (single-threaded decompression)
#
# NOTE: Thread counts and compression levels are tested in ci.yml (edge-cases)
# =============================================================================
name: Performance Guards

on:
  push:
    branches: ["*"]
  pull_request:
    branches: ["*"]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

env:
  CARGO_TERM_COLOR: always

jobs:
  # ============================================================================
  # Pure Rust Performance Advantages - These MUST be maintained
  # ============================================================================
  bgzf-parallel:
    name: "Guard: BGZF faster than pigz"
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential zlib1g-dev

      - name: Build tools
        run: |
          cargo build --release
          make -C pigz

      - name: Compare BGZF decompression
        run: |
          echo "## BGZF: gzippy vs pigz" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Create test data
          python3 -c "
          import random
          random.seed(42)
          with open('/tmp/test.txt', 'w') as f:
              for _ in range(200000):
                  f.write(''.join(random.choices('abcdefghij', k=100)) + '\n')
          "
          
          # Compress with gzippy (creates BGZF-compatible output)
          ./target/release/gzippy -1 -c /tmp/test.txt > /tmp/test.gz
          SIZE=$(stat -c%s /tmp/test.txt)
          
          # Test gzippy
          ./target/release/gzippy -d < /tmp/test.gz > /tmp/out1.txt  # warmup
          START=$(date +%s.%N)
          for i in 1 2 3 4 5; do
            ./target/release/gzippy -d < /tmp/test.gz > /tmp/out.txt
          done
          END=$(date +%s.%N)
          GZIPPY_TIME=$(echo "($END - $START) / 5" | bc -l)
          GZIPPY_SPEED=$(echo "$SIZE / $GZIPPY_TIME / 1000000" | bc -l)
          
          # Test pigz (unpigz)
          ./pigz/unpigz -c /tmp/test.gz > /tmp/out2.txt  # warmup
          START=$(date +%s.%N)
          for i in 1 2 3 4 5; do
            ./pigz/unpigz -c /tmp/test.gz > /tmp/out.txt
          done
          END=$(date +%s.%N)
          PIGZ_TIME=$(echo "($END - $START) / 5" | bc -l)
          PIGZ_SPEED=$(echo "$SIZE / $PIGZ_TIME / 1000000" | bc -l)
          
          # Verify correctness
          diff /tmp/test.txt /tmp/out.txt
          
          RATIO=$(echo "$GZIPPY_SPEED / $PIGZ_SPEED" | bc -l)
          
          echo "| Tool | Speed (MB/s) |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------------|" >> $GITHUB_STEP_SUMMARY
          printf "| gzippy | %.0f |\n" "$GZIPPY_SPEED" >> $GITHUB_STEP_SUMMARY
          printf "| pigz | %.0f |\n" "$PIGZ_SPEED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          printf "**Ratio**: gzippy is %.2fx of pigz\n" "$RATIO" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Must be faster than pigz (>= 0.95 allows for CI noise)
          if awk "BEGIN {exit !($RATIO >= 0.95)}"; then
            echo "âœ… **PASS**: gzippy BGZF decompression is competitive" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **FAIL**: gzippy slower than pigz on BGZF (${RATIO}x)" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  multi-member-parallel:
    name: "Guard: Multi-member faster than pigz"
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential zlib1g-dev

      - name: Build tools
        run: |
          cargo build --release
          make -C pigz

      - name: Compare multi-member decompression
        run: |
          echo "## Multi-member: gzippy vs pigz" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Create test data
          python3 -c "
          import random
          random.seed(42)
          with open('/tmp/test.txt', 'w') as f:
              for _ in range(100000):
                  f.write(''.join(random.choices('abcdefghij', k=100)) + '\n')
          "
          
          # Compress with pigz (creates multi-member gzip)
          ./pigz/pigz -p4 -c /tmp/test.txt > /tmp/test-pigz.gz
          SIZE=$(stat -c%s /tmp/test.txt)
          
          # Test gzippy
          ./target/release/gzippy -d < /tmp/test-pigz.gz > /tmp/out1.txt  # warmup
          START=$(date +%s.%N)
          for i in 1 2 3 4 5; do
            ./target/release/gzippy -d < /tmp/test-pigz.gz > /tmp/out.txt
          done
          END=$(date +%s.%N)
          GZIPPY_TIME=$(echo "($END - $START) / 5" | bc -l)
          GZIPPY_SPEED=$(echo "$SIZE / $GZIPPY_TIME / 1000000" | bc -l)
          
          # Test pigz (unpigz)
          ./pigz/unpigz -c /tmp/test-pigz.gz > /tmp/out2.txt  # warmup
          START=$(date +%s.%N)
          for i in 1 2 3 4 5; do
            ./pigz/unpigz -c /tmp/test-pigz.gz > /tmp/out.txt
          done
          END=$(date +%s.%N)
          PIGZ_TIME=$(echo "($END - $START) / 5" | bc -l)
          PIGZ_SPEED=$(echo "$SIZE / $PIGZ_TIME / 1000000" | bc -l)
          
          # Verify correctness
          diff /tmp/test.txt /tmp/out.txt
          
          RATIO=$(echo "$GZIPPY_SPEED / $PIGZ_SPEED" | bc -l)
          
          echo "| Tool | Speed (MB/s) |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------------|" >> $GITHUB_STEP_SUMMARY
          printf "| gzippy | %.0f |\n" "$GZIPPY_SPEED" >> $GITHUB_STEP_SUMMARY
          printf "| pigz | %.0f |\n" "$PIGZ_SPEED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          printf "**Ratio**: gzippy is %.2fx of pigz\n" "$RATIO" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Must be faster than pigz (>= 0.95 allows for CI noise)
          if awk "BEGIN {exit !($RATIO >= 0.95)}"; then
            echo "âœ… **PASS**: gzippy multi-member decompression is competitive" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **FAIL**: gzippy slower than pigz on multi-member (${RATIO}x)" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  single-member-gzip:
    name: "Guard: Single-member faster than gzip"
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Compare single-member decompression
        run: |
          echo "## Single-member: gzippy vs gzip" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Create test data
          python3 -c "
          import random
          random.seed(42)
          with open('/tmp/test.txt', 'w') as f:
              for _ in range(100000):
                  f.write(''.join(random.choices('abcdefghij', k=100)) + '\n')
          "
          
          # Compress with gzip (single-member)
          gzip -c /tmp/test.txt > /tmp/test-gzip.gz
          SIZE=$(stat -c%s /tmp/test.txt)
          
          cargo build --release
          
          # Test gzippy
          ./target/release/gzippy -d < /tmp/test-gzip.gz > /tmp/out1.txt  # warmup
          START=$(date +%s.%N)
          for i in 1 2 3 4 5; do
            ./target/release/gzippy -d < /tmp/test-gzip.gz > /tmp/out.txt
          done
          END=$(date +%s.%N)
          GZIPPY_TIME=$(echo "($END - $START) / 5" | bc -l)
          GZIPPY_SPEED=$(echo "$SIZE / $GZIPPY_TIME / 1000000" | bc -l)
          
          # Test gzip
          gzip -d < /tmp/test-gzip.gz > /tmp/out2.txt  # warmup
          gzip -c /tmp/test.txt > /tmp/test-gzip.gz  # recreate since gzip consumed it
          START=$(date +%s.%N)
          for i in 1 2 3 4 5; do
            gzip -d -c /tmp/test-gzip.gz > /tmp/out.txt
          done
          END=$(date +%s.%N)
          GZIP_TIME=$(echo "($END - $START) / 5" | bc -l)
          GZIP_SPEED=$(echo "$SIZE / $GZIP_TIME / 1000000" | bc -l)
          
          # Verify correctness
          diff /tmp/test.txt /tmp/out.txt
          
          RATIO=$(echo "$GZIPPY_SPEED / $GZIP_SPEED" | bc -l)
          
          echo "| Tool | Speed (MB/s) |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------------|" >> $GITHUB_STEP_SUMMARY
          printf "| gzippy | %.0f |\n" "$GZIPPY_SPEED" >> $GITHUB_STEP_SUMMARY
          printf "| gzip | %.0f |\n" "$GZIP_SPEED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          printf "**Ratio**: gzippy is %.2fx of gzip\n" "$RATIO" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Must be faster than gzip (>= 1.0, no slack needed - gzip is slow)
          if awk "BEGIN {exit !($RATIO >= 1.0)}"; then
            echo "âœ… **PASS**: gzippy is faster than gzip" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **FAIL**: gzippy slower than gzip (${RATIO}x)" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  # ============================================================================
  # Guard: Must beat rapidgzip on multi-member files
  # ============================================================================
  vs-rapidgzip:
    name: Guard: Faster than rapidgzip
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake nasm zlib1g-dev

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build tools
        run: |
          cargo build --release
          make -C pigz
          
          # Build rapidgzip
          cd rapidgzip/librapidarchive
          mkdir -p build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release -DWITH_ISAL=OFF
          make -j$(nproc) rapidgzip || echo "rapidgzip build failed"

      - name: Compare gzippy vs rapidgzip
        run: |
          echo "## gzippy vs rapidgzip Comparison" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Create test data
          python3 -c "
          import random
          random.seed(42)
          with open('/tmp/test.txt', 'w') as f:
              for _ in range(200000):
                  f.write(''.join(random.choices('abcdefghij', k=100)) + '\n')
          "
          
          # Compress with pigz (creates multi-member gzip)
          ./pigz/pigz -p4 -c /tmp/test.txt > /tmp/test-pigz.gz
          SIZE=$(stat -c%s /tmp/test.txt)
          CORES=$(nproc)
          
          # Test gzippy
          ./target/release/gzippy -d < /tmp/test-pigz.gz > /tmp/out1.txt  # warmup
          START=$(date +%s.%N)
          for i in 1 2 3 4 5; do
            ./target/release/gzippy -d < /tmp/test-pigz.gz > /tmp/out.txt
          done
          END=$(date +%s.%N)
          GZIPPY_TIME=$(echo "($END - $START) / 5" | bc -l)
          GZIPPY_SPEED=$(echo "$SIZE / $GZIPPY_TIME / 1000000" | bc -l)
          
          # Test rapidgzip (if available)
          RAPIDGZIP_BIN="rapidgzip/librapidarchive/build/tools/rapidgzip"
          if [ -x "$RAPIDGZIP_BIN" ]; then
            $RAPIDGZIP_BIN -d -P $CORES < /tmp/test-pigz.gz > /tmp/out2.txt 2>/dev/null  # warmup
            START=$(date +%s.%N)
            for i in 1 2 3 4 5; do
              $RAPIDGZIP_BIN -d -P $CORES < /tmp/test-pigz.gz > /tmp/out.txt 2>/dev/null
            done
            END=$(date +%s.%N)
            RAPIDGZIP_TIME=$(echo "($END - $START) / 5" | bc -l)
            RAPIDGZIP_SPEED=$(echo "$SIZE / $RAPIDGZIP_TIME / 1000000" | bc -l)
            
            RATIO=$(echo "$GZIPPY_SPEED / $RAPIDGZIP_SPEED" | bc -l)
            
            echo "| Tool | Speed (MB/s) |" >> $GITHUB_STEP_SUMMARY
            echo "|------|-------------|" >> $GITHUB_STEP_SUMMARY
            printf "| gzippy | %.0f |\n" "$GZIPPY_SPEED" >> $GITHUB_STEP_SUMMARY
            printf "| rapidgzip | %.0f |\n" "$RAPIDGZIP_SPEED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            printf "**Ratio**: gzippy is %.2fx of rapidgzip\n" "$RATIO" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Must be faster than rapidgzip (ratio >= 0.95 allows for CI noise)
            if awk "BEGIN {exit !($RATIO >= 0.95)}"; then
              if awk "BEGIN {exit !($RATIO >= 1.0)}"; then
                echo "âœ… **PASS**: gzippy is **faster** than rapidgzip (${RATIO}x)" >> $GITHUB_STEP_SUMMARY
              else
                echo "âœ… **PASS**: gzippy matches rapidgzip (within CI noise)" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "âŒ **FAIL**: gzippy is slower than rapidgzip (${RATIO}x)" >> $GITHUB_STEP_SUMMARY
              echo "   We must be faster. This is a regression." >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          else
            echo "âš ï¸ rapidgzip not available, skipping comparison" >> $GITHUB_STEP_SUMMARY
            printf "gzippy speed: %.0f MB/s\n" "$GZIPPY_SPEED" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # Guard: Must beat rapidgzip on single-member (gzip) files too
  # ============================================================================
  vs-rapidgzip-single:
    name: Guard: Faster than rapidgzip (single-member)
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake nasm zlib1g-dev

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build tools
        run: |
          cargo build --release
          
          # Build rapidgzip
          cd rapidgzip/librapidarchive
          mkdir -p build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release -DWITH_ISAL=OFF
          make -j$(nproc) rapidgzip || echo "rapidgzip build failed"

      - name: Compare on single-member gzip file
        run: |
          echo "## gzippy vs rapidgzip (Single-member)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Create test data
          python3 -c "
          import random
          random.seed(42)
          with open('/tmp/test.txt', 'w') as f:
              for _ in range(200000):
                  f.write(''.join(random.choices('abcdefghij', k=100)) + '\n')
          "
          
          # Compress with standard gzip (creates single-member)
          gzip -c /tmp/test.txt > /tmp/test-gzip.gz
          SIZE=$(stat -c%s /tmp/test.txt)
          CORES=$(nproc)
          
          # Test gzippy
          ./target/release/gzippy -d < /tmp/test-gzip.gz > /tmp/out1.txt  # warmup
          START=$(date +%s.%N)
          for i in 1 2 3 4 5; do
            ./target/release/gzippy -d < /tmp/test-gzip.gz > /tmp/out.txt
          done
          END=$(date +%s.%N)
          GZIPPY_TIME=$(echo "($END - $START) / 5" | bc -l)
          GZIPPY_SPEED=$(echo "$SIZE / $GZIPPY_TIME / 1000000" | bc -l)
          
          # Test rapidgzip (if available)
          RAPIDGZIP_BIN="rapidgzip/librapidarchive/build/tools/rapidgzip"
          if [ -x "$RAPIDGZIP_BIN" ]; then
            $RAPIDGZIP_BIN -d -P $CORES < /tmp/test-gzip.gz > /tmp/out2.txt 2>/dev/null  # warmup
            START=$(date +%s.%N)
            for i in 1 2 3 4 5; do
              $RAPIDGZIP_BIN -d -P $CORES < /tmp/test-gzip.gz > /tmp/out.txt 2>/dev/null
            done
            END=$(date +%s.%N)
            RAPIDGZIP_TIME=$(echo "($END - $START) / 5" | bc -l)
            RAPIDGZIP_SPEED=$(echo "$SIZE / $RAPIDGZIP_TIME / 1000000" | bc -l)
            
            RATIO=$(echo "$GZIPPY_SPEED / $RAPIDGZIP_SPEED" | bc -l)
            
            echo "| Tool | Speed (MB/s) |" >> $GITHUB_STEP_SUMMARY
            echo "|------|-------------|" >> $GITHUB_STEP_SUMMARY
            printf "| gzippy | %.0f |\n" "$GZIPPY_SPEED" >> $GITHUB_STEP_SUMMARY
            printf "| rapidgzip | %.0f |\n" "$RAPIDGZIP_SPEED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            printf "**Ratio**: gzippy is %.2fx of rapidgzip\n" "$RATIO" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Must be faster than rapidgzip (ratio >= 0.95 allows for CI noise)
            if awk "BEGIN {exit !($RATIO >= 0.95)}"; then
              echo "âœ… **PASS**: gzippy competitive on single-member files" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **FAIL**: gzippy slower than rapidgzip on single-member (${RATIO}x)" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          else
            echo "âš ï¸ rapidgzip not available, skipping comparison" >> $GITHUB_STEP_SUMMARY
            printf "gzippy speed: %.0f MB/s\n" "$GZIPPY_SPEED" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # Guard: Must beat igzip on single-threaded decompression
  # ============================================================================
  vs-igzip:
    name: Guard: Faster than igzip (single-threaded)
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake nasm zlib1g-dev

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build tools
        run: |
          cargo build --release
          
          # Build igzip
          cd isa-l
          mkdir -p build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release
          make -j$(nproc) igzip || echo "igzip build failed"

      - name: Compare gzippy vs igzip
        run: |
          echo "## gzippy vs igzip (Single-threaded)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Create test data
          python3 -c "
          import random
          random.seed(42)
          with open('/tmp/test.txt', 'w') as f:
              for _ in range(200000):
                  f.write(''.join(random.choices('abcdefghij', k=100)) + '\n')
          "
          
          # Compress with gzip
          gzip -c /tmp/test.txt > /tmp/test.gz
          SIZE=$(stat -c%s /tmp/test.txt)
          
          # Test gzippy (single-threaded)
          ./target/release/gzippy -d -p1 < /tmp/test.gz > /tmp/out1.txt  # warmup
          START=$(date +%s.%N)
          for i in 1 2 3 4 5; do
            ./target/release/gzippy -d -p1 < /tmp/test.gz > /tmp/out.txt
          done
          END=$(date +%s.%N)
          GZIPPY_TIME=$(echo "($END - $START) / 5" | bc -l)
          GZIPPY_SPEED=$(echo "$SIZE / $GZIPPY_TIME / 1000000" | bc -l)
          
          # Test igzip (if available)
          IGZIP_BIN="isa-l/build/bin/igzip"
          if [ -x "$IGZIP_BIN" ]; then
            $IGZIP_BIN -d < /tmp/test.gz > /tmp/out2.txt 2>/dev/null  # warmup
            START=$(date +%s.%N)
            for i in 1 2 3 4 5; do
              $IGZIP_BIN -d < /tmp/test.gz > /tmp/out.txt 2>/dev/null
            done
            END=$(date +%s.%N)
            IGZIP_TIME=$(echo "($END - $START) / 5" | bc -l)
            IGZIP_SPEED=$(echo "$SIZE / $IGZIP_TIME / 1000000" | bc -l)
            
            RATIO=$(echo "$GZIPPY_SPEED / $IGZIP_SPEED" | bc -l)
            
            echo "| Tool | Speed (MB/s) |" >> $GITHUB_STEP_SUMMARY
            echo "|------|-------------|" >> $GITHUB_STEP_SUMMARY
            printf "| gzippy (1 thread) | %.0f |\n" "$GZIPPY_SPEED" >> $GITHUB_STEP_SUMMARY
            printf "| igzip | %.0f |\n" "$IGZIP_SPEED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            printf "**Ratio**: gzippy is %.2fx of igzip\n" "$RATIO" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Must be at least 90% of igzip speed (igzip is hand-tuned assembly)
            if awk "BEGIN {exit !($RATIO >= 0.90)}"; then
              echo "âœ… **PASS**: gzippy competitive with igzip" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **FAIL**: gzippy too slow vs igzip (${RATIO}x)" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          else
            echo "âš ï¸ igzip not available, skipping comparison" >> $GITHUB_STEP_SUMMARY
            printf "gzippy speed: %.0f MB/s\n" "$GZIPPY_SPEED" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # Summary of all performance regression tests
  # ============================================================================
  summary:
    name: Guards Summary
    runs-on: ubuntu-latest
    needs: [bgzf-parallel, multi-member-parallel, single-member-gzip, vs-rapidgzip, vs-rapidgzip-single, vs-igzip]
    if: always()
    
    steps:
      - name: Generate overall summary
        run: |
          echo "## ðŸ Performance Guards Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "These guards enforce hard performance thresholds. CI fails on regression." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Guard | Threshold | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| BGZF vs pigz | Must be faster | ${{ needs.bgzf-parallel.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Multi-member vs pigz | Must be faster | ${{ needs.multi-member-parallel.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Single-member vs gzip | Must be faster | ${{ needs.single-member-gzip.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| vs rapidgzip (multi) | Must be faster | ${{ needs.vs-rapidgzip.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| vs rapidgzip (single) | Must be faster | ${{ needs.vs-rapidgzip-single.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| vs igzip | >= 90% speed | ${{ needs.vs-igzip.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note**: Thread counts and compression levels are tested for correctness" >> $GITHUB_STEP_SUMMARY
          echo "in the Build & Test workflow (edge-cases job)." >> $GITHUB_STEP_SUMMARY
