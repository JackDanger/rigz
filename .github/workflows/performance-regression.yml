# =============================================================================
# Performance Guards: Protect our performance advantages
# =============================================================================
# These tests enforce hard thresholds. CI FAILS if we regress:
#
# - BGZF Parallel: MUST achieve â‰¥500 MB/s (CI-conservative; local: ~3900 MB/s)
# - Multi-member: MUST achieve â‰¥300 MB/s
# - Single-member: MUST achieve â‰¥300 MB/s
#
# These encode our key wins:
# - BGZF parallel is 2.9x faster than libdeflate single-thread
# - Multi-member parallel handles pigz-style files efficiently
#
# NOTE: Thread counts and compression levels are tested in ci.yml (edge-cases)
# =============================================================================
name: Performance Guards

on:
  push:
    branches: ["*"]
  pull_request:
    branches: ["*"]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

env:
  CARGO_TERM_COLOR: always

jobs:
  # ============================================================================
  # Pure Rust Performance Advantages - These MUST be maintained
  # ============================================================================
  bgzf-parallel:
    name: Guard: BGZF Parallel â‰¥500 MB/s
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Run BGZF parallel benchmark
        run: |
          echo "## BGZF Parallel Performance" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          cargo build --release
          
          # Create compressible test data (BGZF shines on compressible data)
          python3 -c "
          import random
          random.seed(42)
          with open('/tmp/test.txt', 'w') as f:
              for _ in range(200000):
                  f.write(''.join(random.choices('abcdefghij', k=100)) + '\n')
          "
          
          # Compress with gzippy (creates BGZF-compatible output)
          ./target/release/gzippy -1 -c /tmp/test.txt > /tmp/test.gz
          SIZE=$(stat -c%s /tmp/test.txt)
          
          # Warmup
          ./target/release/gzippy -d < /tmp/test.gz > /tmp/out1.txt
          
          # Timed runs
          START=$(date +%s.%N)
          for i in 1 2 3 4 5; do
            ./target/release/gzippy -d < /tmp/test.gz > /tmp/out.txt
          done
          END=$(date +%s.%N)
          
          TOTAL_TIME=$(echo "$END - $START" | bc)
          AVG_TIME=$(echo "$TOTAL_TIME / 5" | bc -l)
          SPEED=$(echo "$SIZE / $AVG_TIME / 1000000" | bc -l)
          
          # Verify correctness
          diff /tmp/test.txt /tmp/out.txt
          
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| File size | ${SIZE} bytes |" >> $GITHUB_STEP_SUMMARY
          echo "| Avg time | ${AVG_TIME}s |" >> $GITHUB_STEP_SUMMARY
          printf "| Speed | %.0f MB/s |\n" "$SPEED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check threshold: BGZF parallel should be > 500 MB/s (conservative for CI runners)
          # Note: Local benchmarks show 3000+ MB/s, but CI runners are slower
          THRESHOLD=500
          if awk "BEGIN {exit !($SPEED > $THRESHOLD)}"; then
            echo "âœ… **PASS**: BGZF decompression $(printf '%.0f' $SPEED) MB/s > ${THRESHOLD} MB/s" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **FAIL**: BGZF decompression too slow" >> $GITHUB_STEP_SUMMARY
            echo "   Got: $(printf '%.0f' $SPEED) MB/s, Threshold: ${THRESHOLD} MB/s" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  multi-member-parallel:
    name: Guard: Multi-member â‰¥300 MB/s
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential zlib1g-dev

      - name: Build tools
        run: |
          cargo build --release
          make -C pigz

      - name: Test multi-member decompression
        run: |
          echo "## Multi-member Parallel Performance" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Create test data
          python3 -c "
          import random
          random.seed(42)
          with open('/tmp/test.txt', 'w') as f:
              for _ in range(100000):
                  f.write(''.join(random.choices('abcdefghij', k=100)) + '\n')
          "
          
          # Compress with pigz (creates multi-member gzip)
          ./pigz/pigz -p4 -c /tmp/test.txt > /tmp/test-pigz.gz
          
          # Decompress with gzippy and measure
          CORES=$(nproc)
          
          # Warmup
          ./target/release/gzippy -d < /tmp/test-pigz.gz > /tmp/out1.txt
          
          # Timed run
          START=$(date +%s.%N)
          for i in 1 2 3 4 5; do
            ./target/release/gzippy -d < /tmp/test-pigz.gz > /tmp/out.txt
          done
          END=$(date +%s.%N)
          
          TOTAL_TIME=$(echo "$END - $START" | bc)
          AVG_TIME=$(echo "$TOTAL_TIME / 5" | bc -l)
          SIZE=$(stat -c%s /tmp/test.txt)
          SPEED=$(echo "$SIZE / $AVG_TIME / 1000000" | bc -l)
          
          # Verify correctness
          diff /tmp/test.txt /tmp/out.txt
          
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| File size | ${SIZE} bytes |" >> $GITHUB_STEP_SUMMARY
          echo "| Avg time | ${AVG_TIME}s |" >> $GITHUB_STEP_SUMMARY
          printf "| Speed | %.0f MB/s |\n" "$SPEED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check threshold: multi-member should be > 300 MB/s (conservative for CI)
          THRESHOLD=300
          if awk "BEGIN {exit !($SPEED > $THRESHOLD)}"; then
            echo "âœ… **PASS**: Multi-member decompression $(printf '%.0f' $SPEED) MB/s > ${THRESHOLD} MB/s" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **FAIL**: Multi-member decompression too slow" >> $GITHUB_STEP_SUMMARY
            echo "   Got: $(printf '%.0f' $SPEED) MB/s, Threshold: ${THRESHOLD} MB/s" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  single-member-gzip:
    name: Guard: Single-member â‰¥300 MB/s
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Test single-member decompression
        run: |
          echo "## Single-member gzip Performance" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Create test data
          python3 -c "
          import random
          random.seed(42)
          with open('/tmp/test.txt', 'w') as f:
              for _ in range(100000):
                  f.write(''.join(random.choices('abcdefghij', k=100)) + '\n')
          "
          
          # Compress with gzip (single-member)
          gzip -c /tmp/test.txt > /tmp/test-gzip.gz
          
          cargo build --release
          
          # Warmup
          ./target/release/gzippy -d < /tmp/test-gzip.gz > /tmp/out1.txt
          
          # Timed runs
          START=$(date +%s.%N)
          for i in 1 2 3 4 5; do
            ./target/release/gzippy -d < /tmp/test-gzip.gz > /tmp/out.txt
          done
          END=$(date +%s.%N)
          
          TOTAL_TIME=$(echo "$END - $START" | bc)
          AVG_TIME=$(echo "$TOTAL_TIME / 5" | bc -l)
          SIZE=$(stat -c%s /tmp/test.txt)
          SPEED=$(echo "$SIZE / $AVG_TIME / 1000000" | bc -l)
          
          # Verify correctness
          diff /tmp/test.txt /tmp/out.txt
          
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| File size | ${SIZE} bytes |" >> $GITHUB_STEP_SUMMARY
          echo "| Avg time | ${AVG_TIME}s |" >> $GITHUB_STEP_SUMMARY
          printf "| Speed | %.0f MB/s |\n" "$SPEED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check threshold: single-member should be > 300 MB/s (conservative for CI)
          THRESHOLD=300
          if awk "BEGIN {exit !($SPEED > $THRESHOLD)}"; then
            echo "âœ… **PASS**: Single-member decompression $(printf '%.0f' $SPEED) MB/s > ${THRESHOLD} MB/s" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **FAIL**: Single-member decompression too slow" >> $GITHUB_STEP_SUMMARY
            echo "   Got: $(printf '%.0f' $SPEED) MB/s, Threshold: ${THRESHOLD} MB/s" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  # ============================================================================
  # Summary of all performance regression tests
  # ============================================================================
  summary:
    name: Guards Summary
    runs-on: ubuntu-latest
    needs: [bgzf-parallel, multi-member-parallel, single-member-gzip]
    if: always()
    
    steps:
      - name: Generate overall summary
        run: |
          echo "## ðŸ Performance Guards Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "These guards enforce hard performance thresholds. CI fails on regression." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Guard | Threshold | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| BGZF Parallel | â‰¥500 MB/s | ${{ needs.bgzf-parallel.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Multi-member | â‰¥300 MB/s | ${{ needs.multi-member-parallel.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Single-member | â‰¥300 MB/s | ${{ needs.single-member-gzip.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note**: Thread counts and compression levels are tested for correctness" >> $GITHUB_STEP_SUMMARY
          echo "in the Build & Test workflow (edge-cases job)." >> $GITHUB_STEP_SUMMARY
