# =============================================================================
# Release Packages: Build and publish Debian packages
# =============================================================================
# - Builds .deb packages on version tags (v*)
# - Tests package installation
# - Creates GitHub release with artifacts
# =============================================================================
name: Release Packages

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:  # Allow manual runs

# Permissions for checkout and creating releases
permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  build-deb:
    name: Build Debian Packages
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [amd64]
        # arm64 builds would need a different runner or cross-compilation

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true  # Only direct submodules (pigz)

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            debhelper \
            devscripts \
            build-essential \
            zlib1g-dev

      - name: Build Debian packages
        run: |
          dpkg-buildpackage -us -uc -b

      - name: List built packages
        run: ls -la ../*.deb

      - name: Test package installation
        run: |
          sudo dpkg -i ../gzippy_*.deb
          gzippy --version
          
          # Test basic functionality
          echo "Hello, World!" | gzippy -c | gzippy -d
          
          echo "✓ gzippy package works correctly"

      - name: Test gzip replacement package
        run: |
          sudo dpkg -i ../gzippy-replace-gzip_*.deb
          
          # Verify gzip is now gzippy
          which gzip
          ls -la /usr/bin/gzip
          
          # Test gzip compatibility
          echo "Test data for gzip replacement" > /tmp/test.txt
          gzip -c /tmp/test.txt > /tmp/test.txt.gz
          gunzip -c /tmp/test.txt.gz > /tmp/test2.txt
          diff /tmp/test.txt /tmp/test2.txt
          
          echo "✓ gzippy-replace-gzip package works correctly"

      - name: Upload packages
        uses: actions/upload-artifact@v4
        with:
          name: debian-packages-${{ matrix.arch }}
          path: |
            ../*.deb
            ../*.changes

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build-deb
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: packages

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: packages/**/*.deb
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
