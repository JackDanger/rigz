# =============================================================================
# PR Performance Summary: Aggregate results from compression/decompression workflows
# =============================================================================
# This workflow triggers AFTER the compression and decompression benchmarks complete.
# It downloads their artifacts, aggregates the results, and posts a unified summary.
#
# Key design decisions:
# - Uses workflow_run trigger to wait for other workflows to complete
# - No redundant benchmark runs - trusts numbers from dedicated workflows
# - All logic extracted into Python scripts for maintainability
# =============================================================================
name: PR Summary

on:
  # Trigger after benchmark workflows complete
  workflow_run:
    workflows:
      - "Compression Benchmarks"
      - "Decompression Benchmarks"
    types:
      - completed
  
  # Allow manual triggering for debugging
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  actions: read  # Needed to download artifacts from other workflows

jobs:
  aggregate-and-summarize:
    name: Generate Performance Summary
    runs-on: ubuntu-latest
    # Only run if the triggering workflow succeeded (or on manual dispatch)
    if: >
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'
    
    steps:
      - uses: actions/checkout@v4

      - name: Get PR number from triggering workflow
        id: pr
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "pr_number=" >> $GITHUB_OUTPUT
            echo "Manual dispatch - no PR associated"
          else
            # Get the PR number from the triggering workflow run
            PR_NUMBER=$(curl -s -H "Authorization: token ${{ github.token }}" \
              "${{ github.event.workflow_run.repository.url }}/actions/runs/${{ github.event.workflow_run.id }}" \
              | jq -r '.pull_requests[0].number // empty')
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            echo "PR number: $PR_NUMBER"
          fi

      - name: Collect system info
        run: |
          mkdir -p results
          python3 scripts/collect_system_info.py --output results/system.json
          cat results/system.json

      - name: Download compression artifacts
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: compression.yml
          run_id: ${{ github.event.workflow_run.id }}
          path: results/compression
          if_no_artifact_found: warn
        continue-on-error: true

      - name: Download decompression artifacts
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: decompression.yml
          run_id: ${{ github.event.workflow_run.id }}
          path: results/decompression
          if_no_artifact_found: warn
        continue-on-error: true

      - name: Try to find latest artifacts from both workflows
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "Manual dispatch - attempting to download latest artifacts..."
          # This is a fallback for manual testing
        continue-on-error: true

      - name: Debug downloaded artifacts
        run: |
          echo "=== Artifact Structure ==="
          find results -type f -name "*.json" | head -30
          echo ""
          echo "=== Sample files ==="
          for f in $(find results -name "*.json" | head -3); do
            echo "--- $f ---"
            head -20 "$f"
            echo ""
          done

      - name: Aggregate benchmark results
        run: |
          python3 scripts/aggregate_benchmark_results.py \
            --input-dir results \
            --output-dir aggregated
          
          echo "=== Aggregated Compression ==="
          cat aggregated/compression.json | head -50
          
          echo ""
          echo "=== Aggregated Decompression ==="
          cat aggregated/decompression.json | head -50

      - name: Generate summary
        run: |
          python3 scripts/generate_summary.py \
            --system results/system.json \
            --compression aggregated/compression.json \
            --decompression aggregated/decompression.json \
            --output summary.md
          
          cat summary.md >> $GITHUB_STEP_SUMMARY
          echo ""
          echo "=== Summary Generated ==="
          cat summary.md

      - name: Post comment to PR
        if: steps.pr.outputs.pr_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let summary;
            try {
              summary = fs.readFileSync('summary.md', 'utf8');
            } catch {
              summary = '## gzippy Performance Summary\n\nNo benchmark results available yet.';
            }
            
            const prNumber = parseInt('${{ steps.pr.outputs.pr_number }}');
            if (!prNumber) {
              console.log('No PR number - skipping comment');
              return;
            }
            
            const body = summary + '\n\n---\n*Updated: ' + new Date().toISOString() + '*';
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            
            const marker = '# ðŸš€ gzippy Performance Summary';
            const botComment = comments.find(c => 
              c.user.type === 'Bot' && 
              c.body && c.body.includes(marker)
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
              console.log('Updated existing comment');
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body
              });
              console.log('Created new comment');
            }

      - name: Upload aggregated results
        uses: actions/upload-artifact@v4
        with:
          name: aggregated-benchmark-results
          path: |
            aggregated/
            results/system.json
            summary.md
          retention-days: 30
