#!/bin/bash
# Pre-commit hook to validate code before committing
# Install with: ln -sf ../../scripts/pre-commit .git/hooks/pre-commit

set -e

# Check YAML syntax in .github/ directory
echo "Checking YAML syntax in .github/..."
yaml_error=0
for yaml_file in $(git diff --cached --name-only --diff-filter=ACM | grep -E '\.github/.*\.ya?ml$' || true); do
    if [ -f "$yaml_file" ]; then
        if ! ruby -ryaml -e "YAML.safe_load(File.read('$yaml_file'))" 2>&1; then
            echo "Error: YAML syntax error in $yaml_file"
            yaml_error=1
        fi
    fi
done
if [ $yaml_error -eq 1 ]; then
    exit 1
fi

echo "Running cargo fmt --check..."
if ! cargo fmt --check; then
    echo "Error: Code is not formatted. Run 'cargo fmt' to fix."
    exit 1
fi

echo "Running cargo clippy..."
if ! cargo clippy --all-targets --all-features -- -D warnings 2>&1; then
    echo "Error: Clippy found warnings. Fix them before committing."
    exit 1
fi

echo "Pre-commit checks passed!"
